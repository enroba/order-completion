<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Enroba Orders</title>
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 700px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f4f8;
            color: #2c3e50;
        }

        h1 {
            text-align: center;
            color: #1abc9c;
            font-size: 26px;
            margin-bottom: 25px;
            letter-spacing: 1px;
        }

        /* New styles for counts */
        #order-counts {
            text-align: center;
            margin-bottom: 20px;
            font-size: 16px;
            color: #34495e;
        }

        #order-counts span {
            display: inline-block;
            margin: 0 15px;
            font-weight: 600;
        }

        #order-counts .pending {
            color: #e67e22;
        }

        #order-counts .shipped {
            color: #27ae60;
        }

        #search-container {
            text-align: center;
            margin-bottom: 25px;
        }

        #search-input {
            width: 100%;
            max-width: 500px;
            padding: 12px 16px;
            font-size: 16px;
            border: 2px solid #1abc9c;
            border-radius: 10px;
            outline: none;
            transition: 0.3s ease;
        }

        #search-input:focus {
            border-color: #16a085;
            box-shadow: 0 0 10px rgba(22, 160, 133, 0.3);
        }

        .order {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            transition: transform 0.2s ease;
        }

        .order:hover {
            transform: scale(1.01);
        }

        .order h2 {
            font-size: 18px;
            margin-bottom: 12px;
            color: #1abc9c;
            letter-spacing: 0.5px;
        }

        .order p {
            margin: 10px 0;
            font-size: 15px;
            line-height: 1.6;
        }

        .order p strong {
            display: block;
            color: #34495e;
            margin-bottom: 2px;
        }

        .copy-btn {
            margin-top: 6px;
            padding: 6px 14px;
            font-size: 14px;
            border: none;
            background-color: #1abc9c;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.3s ease;
        }

        .copy-btn:hover {
            background-color: #16a085;
        }

        .label-link {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 14px;
            flex-wrap: wrap;
        }

        .label-link a {
            background: #1abc9c;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            box-shadow: 0 3px 8px rgba(26, 188, 156, 0.3);
            transition: 0.3s ease;
        }

        .label-link a:hover {
            background-color: #16a085;
            box-shadow: 0 5px 12px rgba(22, 160, 133, 0.4);
        }

        /* Separated buttons container */
        .order-buttons {
            margin-top: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 220px;
        }

        .mark-complete-btn {
            padding: 8px 16px;
            font-size: 14px;
            border: none;
            background-color: #27ae60;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 3px 8px rgba(39, 174, 96, 0.4);
            transition: 0.3s ease;
        }

        .mark-complete-btn:hover:not(:disabled) {
            background-color: #219150;
            box-shadow: 0 5px 12px rgba(33, 145, 80, 0.5);
        }

        .mark-complete-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        .received-vendor-btn {
            padding: 8px 16px;
            font-size: 14px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 3px 8px rgba(0, 123, 255, 0.4);
            transition: 0.3s ease;
        }

        .received-vendor-btn:hover:not(:disabled) {
            background-color: #0056b3;
            box-shadow: 0 5px 12px rgba(0, 86, 179, 0.5);
        }

        .received-vendor-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        .address-block {
            background: #ecfdf5;
            border-left: 4px solid #1abc9c;
            padding: 10px 12px;
            margin-top: 6px;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.6;
            color: #2c3e50;
            white-space: pre-line;
            word-wrap: break-word;
        }

        #spinner {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 40px 0;
            color: #555;
        }

        .loader {
            border: 6px solid #e0e0e0;
            border-top: 6px solid #1abc9c;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #refresh-button {
            display: none;
            margin: 0 auto 30px auto;
            padding: 10px 22px;
            background: #1abc9c;
            color: white;
            border: none;
            font-size: 15px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(26, 188, 156, 0.4);
            transition: 0.3s ease;
        }

        #refresh-button:hover {
            background: #16a085;
        }

        /* New styles for inline fields */
        .field-inline {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin: 10px 0;
            font-size: 15px;
        }

        .field-inline strong {
            min-width: 90px;
            color: #34495e;
        }

        .copy-btn-inline {
            margin: 0;
            padding: 4px 10px;
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
            background-color: #1abc9c;
            color: white;
            border: none;
            transition: 0.3s ease;
        }

        .copy-btn-inline:hover {
            background-color: #16a085;
        }

        .flex-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin: 10px 0;
            font-size: 15px;
        }

        .flex-row>p {
            margin: 0;
            white-space: nowrap;
        }

        .flex-row strong {
            color: #34495e;
            min-width: 110px;
            display: inline-block;
        }

        /* âœ… Responsive Fix for Mobile */
        @media (max-width: 500px) {
            body {
                padding: 12px;
            }

            h1 {
                font-size: 20px;
                margin-bottom: 20px;
            }

            #search-input {
                width: 100%;
                font-size: 14px;
                padding: 10px 14px;
                border-radius: 8px;
            }

            .order {
                padding: 15px;
                margin-bottom: 18px;
                border-radius: 10px;
            }

            .order h2 {
                font-size: 16px;
            }

            .order p {
                font-size: 14px;
            }

            .address-block {
                font-size: 13px;
                padding: 8px 10px;
                border-radius: 5px;
            }

            .copy-btn {
                font-size: 13px;
                padding: 5px 10px;
                margin-top: 4px;
            }

            .copy-btn-inline {
                font-size: 12px;
                padding: 4px 8px;
            }

            .label-link a {
                font-size: 13px;
                padding: 7px 12px;
                border-radius: 5px;
            }

            .mark-complete-btn,
            .received-vendor-btn {
                font-size: 13px;
                padding: 7px 12px;
            }

            #refresh-button {
                font-size: 14px;
                padding: 8px 16px;
                margin-bottom: 70px;
            }
        }

        /* === Sticky Top Bar & Filter Styles === */
        #top-bar {
            position: static;
            top: 0;
            background-color: #f0f4f8;
            padding: 10px 0;
            z-index: 1000;
        }

        #filter-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 15px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 20px;
        }

        #filter-select {
            padding: 10px 16px;
            font-size: 15px;
            border-radius: 8px;
            border: 2px solid #1abc9c;
            background-color: #fff;
            color: #2c3e50;
            cursor: pointer;
        }

        @media (max-width: 500px) {
            #filter-bar {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>

<body>
    <!-- Sticky Top Bar -->
    <div id="top-bar" role="banner" aria-label="Order controls and filter">
        <h1>Enroba Order Completion</h1>

        <div id="filter-bar">
            <div id="order-counts" aria-live="polite" aria-atomic="true">
                <span class="pending">Pending: 0</span>
                <span class="shipped">Shipped: 0</span>
            </div>

            <select id="filter-select" aria-label="Filter orders by status">
                <option value="all">All</option>
                <option value="pending">Pending</option>
                <option value="shipped">Shipped</option>
            </select>
        </div>
    </div>

    <div id="search-container">
        <input type="search" id="search-input" placeholder="ðŸ” Search by address, courier, brand..." autocomplete="off" disabled aria-label="Search orders" />
    </div>

    <div id="spinner" aria-live="polite" aria-busy="true">
        <div class="loader" aria-hidden="true"></div>
        <p>Loading orders, please wait...</p>
    </div>

    <div id="orders" style="display:none;"></div>

    <button id="refresh-button" aria-label="Refresh orders">ðŸ”„ Refresh Orders</button>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwy6otpLST30pWsEbIUS2kfNacUK12UwMnOv0XKu2zvmDLME03Nm4TrCQfLQgLkAyLn/exec';

        let allOrders = [];
        let filteredOrders = [];

        const orderCountsEl = document.getElementById('order-counts');
        const filterSelectEl = document.getElementById('filter-select');
        const searchInputEl = document.getElementById('search-input');

        function createAddressHtml(address) {
            if (!address || address.trim() === '') return '';
            const formatted = address.replace(/\n/g, '<br>');
            return `
        <p>
          <strong>Delivery Address:</strong>
          <div class="address-block">
            <span class="copy-text">${formatted}</span><br>
            <button class="copy-btn" type="button" data-copy-value="${address}">ðŸ“‹ Copy</button>
          </div>
        </p>`;
        }

        function createOrderElement(order, index) {
            const orderDiv = document.createElement('div');
            orderDiv.classList.add('order');

            let html = `<h2>${index + 1}. Order #${order['Order Number']}</h2>`;
            html += createAddressHtml(order['Delivery Address']);

            if (order['Country']) {
                html += `
          <div class="field-inline">
            <strong>Country:</strong>
            <span>${order['Country']}</span>
          </div>
        `;
            }

            html += `
        <div class="flex-row">
          <p><strong>Quantity:</strong> ${order['Quantity']}</p>
          <p><strong>Courier:</strong> ${order['Courier']}</p>
          <p class="order-status"><strong>Order Status:</strong> ${order['Order Status']}</p>
        </div>
      `;

            if (order['Brand Name']) {
                html += `<p><strong>Brand Name:</strong> ${order['Brand Name']}</p>`;
            }
            if (order['Dress Name / SKU']) {
                html += `<p><strong>Dress Name / SKU:</strong> ${order['Dress Name / SKU']}</p>`;
            }
            if (order['Notes']) {
                html += `<p><strong>Notes:</strong> ${order['Notes']}</p>`;
            }

            // Buttons container separate from label link
            html += `<div class="order-buttons">`;

            const isShipped = order['Order Status'] && order['Order Status'].toLowerCase() === 'shipped';
            html += `
        <button
          class="mark-complete-btn"
          type="button"
          data-order-number="${order['Order Number']}"
          ${isShipped ? 'disabled' : ''}
        >
          ${isShipped ? 'âœ… Marked Completed' : 'Mark as Complete'}
        </button>
      `;

            const receivedFromVendor = order['Received from Vendor'] && order['Received from Vendor'].trim().toLowerCase() === 'yes';

            html += `
  <button
    class="received-vendor-btn"
    type="button"
    data-order-number="${order['Order Number']}"
    data-vendor-btn
    ${receivedFromVendor ? 'disabled' : ''}
  >
    ${receivedFromVendor ? 'âœ… Received from Vendor' : 'Received from Vendor'}
  </button>
`;

            html += `</div>`;

            if (order['Label URL'] && order['Label URL'].trim() !== '') {
                html += `
          <p class="label-link">
            <a href="${order['Label URL']}" target="_blank" rel="noopener noreferrer">ðŸ“Ž Download Label</a>
          </p>
        `;
            }

            orderDiv.innerHTML = html;

            // Copy buttons
            orderDiv.querySelectorAll('.copy-btn, .copy-btn-inline').forEach((button) => {
                button.addEventListener('click', () => {
                    const textToCopy = button.getAttribute('data-copy-value');
                    if (!navigator.clipboard) {
                        // fallback for old browsers
                        const textarea = document.createElement('textarea');
                        textarea.value = textToCopy;
                        document.body.appendChild(textarea);
                        textarea.select();
                        try {
                            document.execCommand('copy');
                            alert('Copied to clipboard!');
                        } catch {
                            alert('Failed to copy');
                        }
                        document.body.removeChild(textarea);
                    } else {
                        navigator.clipboard.writeText(textToCopy).then(() => {
                            button.textContent = 'âœ… Copied!';
                            setTimeout(() => {
                                button.textContent = 'ðŸ“‹ Copy';
                            }, 1200);
                        }).catch(() => {
                            alert('Failed to copy');
                        });
                    }
                });
            });

            // Mark Complete button with confirmation prompt
            orderDiv.querySelectorAll('.mark-complete-btn').forEach((button) => {
                button.addEventListener('click', async () => {
                    const orderNumber = button.getAttribute('data-order-number');

                    if (!confirm(`Are you sure you want to mark order #${orderNumber} as complete?`)) {
                        return;
                    }

                    button.disabled = true;
                    button.textContent = 'Updating...';

                    try {
                        const formData = new URLSearchParams();
                        formData.append('action', 'updateStatus');
                        formData.append('orderNumber', orderNumber);
                        formData.append('value', 'Shipped');

                        const response = await fetch(API_URL, {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert(`Order #${orderNumber} marked as complete.`);
                            button.disabled = true;
                            button.textContent = 'âœ… Marked Completed';

                            // Also update the displayed Order Status text in that order div:
                            const orderDiv = button.closest('.order');
                            if (orderDiv) {
                                const statusEl = orderDiv.querySelector('.order-status strong + span') || orderDiv.querySelector('.order-status');
                                if (statusEl) {
                                    statusEl.textContent = ' Shipped';
                                }
                            }
                        } else {
                            alert(`Failed to update order #${orderNumber}: ${result.message || 'Unknown error'}`);
                            button.disabled = false;
                            button.textContent = 'Mark as Complete';
                        }
                    } catch (err) {
                        alert(`Error updating order: ${err.message}`);
                        button.disabled = false;
                        button.textContent = 'Mark as Complete';
                    }
                });
            });

            // Received from Vendor button with confirmation prompt
            orderDiv.querySelectorAll('.received-vendor-btn').forEach((button) => {
                button.addEventListener('click', async () => {
                    const orderNumber = button.getAttribute('data-order-number');

                    if (!confirm(`Confirm order #${orderNumber} has been received from vendor?`)) {
                        return;
                    }

                    button.disabled = true;
                    button.textContent = 'Updating...';

                    try {
                        const formData = new URLSearchParams();
                        formData.append('action', 'updateVendor');
                        formData.append('orderNumber', orderNumber);
                        formData.append('value', 'Yes');

                        const response = await fetch(API_URL, {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert(`Order #${orderNumber} marked as received from vendor.`);
                            button.disabled = true;
                            button.textContent = 'âœ… Received from Vendor';
                        } else {
                            alert(`Failed to update vendor status for order #${orderNumber}: ${result.message || 'Unknown error'}`);
                            button.disabled = false;
                            button.textContent = 'Received from Vendor';
                        }
                    } catch (err) {
                        alert(`Error updating vendor status: ${err.message}`);
                        button.disabled = false;
                        button.textContent = 'Received from Vendor';
                    }
                });
            });

            return orderDiv;
        }

        function updateCounts(orders) {
            const pending = orders.filter(o => (o['Order Status'] || '').toLowerCase() !== 'shipped').length;
            const shipped = orders.filter(o => (o['Order Status'] || '').toLowerCase() === 'shipped').length;

            orderCountsEl.innerHTML = `
        <span class="pending">Pending: ${pending}</span>
        <span class="shipped">Shipped: ${shipped}</span>
      `;
        }

      function filterOrders() {
  const filterValue = filterSelectEl.value;
  let filtered = allOrders;

  // Exclude delivered orders first
  filtered = filtered.filter(o => (o['Order Status'] || '').toLowerCase() !== 'delivered');

  if (filterValue === 'pending') {
    filtered = filtered.filter(o => (o['Order Status'] || '').toLowerCase() !== 'shipped');
  } else if (filterValue === 'shipped') {
    filtered = filtered.filter(o => (o['Order Status'] || '').toLowerCase() === 'shipped');
  }

  // Sort so pending orders come first, shipped after
  filtered.sort((a, b) => {
    const statusA = (a['Order Status'] || '').toLowerCase();
    const statusB = (b['Order Status'] || '').toLowerCase();

    if (statusA === 'shipped' && statusB !== 'shipped') return 1;  // shipped goes after
    if (statusA !== 'shipped' && statusB === 'shipped') return -1; // pending goes before
    return 0; // otherwise keep original order
  });

  filteredOrders = filtered;
  updateCounts(filteredOrders);
  renderOrders(filteredOrders);
}



        function searchOrders(query) {
            const lowerQuery = query.trim().toLowerCase();

            if (lowerQuery === '') {
                renderOrders(filteredOrders);
                return;
            }

            const searched = filteredOrders.filter(o => {
                return (
                    (o['Delivery Address'] && o['Delivery Address'].toLowerCase().includes(lowerQuery)) ||
                    (o['Courier'] && o['Courier'].toLowerCase().includes(lowerQuery)) ||
                    (o['Brand Name'] && o['Brand Name'].toLowerCase().includes(lowerQuery)) ||
                    (o['Dress Name / SKU'] && o['Dress Name / SKU'].toLowerCase().includes(lowerQuery))
                );
            });

            // Make sure delivered orders are still excluded:
            const searchedFiltered = searched.filter(o => (o['Order Status'] || '').toLowerCase() !== 'delivered');

            renderOrders(searchedFiltered);
        }


        function renderOrders(orders) {
            const container = document.getElementById('orders');
            container.innerHTML = '';

            if (orders.length === 0) {
                container.innerHTML = `<p>No orders found.</p>`;
                return;
            }

            orders.forEach((order, i) => {
                const el = createOrderElement(order, i);
                container.appendChild(el);
            });
        }

        async function loadOrders() {
            document.getElementById('spinner').style.display = 'flex';
            document.getElementById('orders').style.display = 'none';
            document.getElementById('refresh-button').style.display = 'none';
            searchInputEl.disabled = true;
            searchInputEl.value = '';

            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                if (Array.isArray(data)) {
                    allOrders = data;
                    filterOrders();
                    document.getElementById('spinner').style.display = 'none';
                    document.getElementById('orders').style.display = 'block';
                    searchInputEl.disabled = false;
                    document.getElementById('refresh-button').style.display = 'inline-block';
                } else {
                    throw new Error('Unexpected data format');
                }
            } catch (err) {
                document.getElementById('spinner').style.display = 'none';
                document.getElementById('orders').style.display = 'block';
                document.getElementById('orders').innerHTML = `<p style="color:red;">Failed to load orders: ${err.message}</p>`;
                document.getElementById('refresh-button').style.display = 'inline-block';
            }
        }

        // Event listeners
        filterSelectEl.addEventListener('change', () => {
            filterOrders();
            searchInputEl.value = '';
        });

        searchInputEl.addEventListener('input', (e) => {
            searchOrders(e.target.value);
        });

        document.getElementById('refresh-button').addEventListener('click', () => {
            loadOrders();
        });

        loadOrders();
    </script>
</body>

</html>

